name: Stable Multi-Page Compiler

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-archive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm init -y
          npm install react react-dom vite @vitejs/plugin-react --save-dev

      - name: Create Production Vite Config
        run: |
          cat <<EOF > vite.config.mjs
          import { defineConfig } from 'vite';
          import react from '@vitejs/plugin-react';
          import { resolve, join } from 'path';
          import { readdirSync, statSync } from 'fs';

          const pagesPath = resolve(process.cwd(), 'src/pages');
          const pages = readdirSync(pagesPath).filter(f => 
            statSync(join(pagesPath, f)).isDirectory()
          );

          const entryPoints = {};
          pages.forEach(page => {
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„ Ù‚Ø¨Ù„ Ø§Ø² Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª Ø¨ÛŒÙ„Ø¯
            const entryPath = resolve(pagesPath, page, 'index.jsx');
            entryPoints[page] = entryPath;
          });

          export default defineConfig({
            plugins: [react()],
            build: {
              outDir: 'dist-pages',
              emptyOutDir: true,
              rollupOptions: {
                input: entryPoints,
                output: {
                  // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙØ±Ù…Øª 'es' Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ú†Ù†Ø¯ ÙˆØ±ÙˆØ¯ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†
                  format: 'es',
                  entryFileNames: '[name]/[name].js',
                  chunkFileNames: 'shared/[name]-[hash].js',
                  assetFileNames: '[name]/[name].[ext]'
                }
              }
            }
          });
          EOF

      - name: Run Compiler
        run: npx vite build

      - name: Professional Archiving
        run: |
          mkdir -p final-archives
          cd dist-pages
          # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨ÛŒÙ„Ø¯ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ Ùˆ Ø²ÛŒÙ¾ Ú©Ø±Ø¯Ù† Ø¢Ù†â€ŒÙ‡Ø§
          for dir in */; do
            if [ -d "$dir" ] && [ "$dir" != "shared/" ]; then
              folder_name=${dir%/}
              echo "ğŸ“¦ Zipping page: $folder_name"
              # Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù¾ÙˆØ´Ù‡ shared (Ú©Ø¯Ù‡Ø§ÛŒ Ù…Ø´ØªØ±Ú© Ø±ÛŒâ€ŒØ§Ú©Øª) Ø¯Ø± Ù‡Ø± Ù¾Ú©ÛŒØ¬ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙ‚Ù„Ø§Ù„ Ú©Ø§Ù…Ù„
              if [ -d "shared" ]; then
                cp -r shared "$dir"
              fi
              zip -r9 "../final-archives/${folder_name}.zip" "$dir"
            fi
          done
          cd ..

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: production-pages-${{ github.run_number }}
          path: final-archives/*.zip
