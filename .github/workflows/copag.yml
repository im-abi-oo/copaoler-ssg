name: Independent Page Compiler

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-archive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Initialize Environment & Install Core Tools
        # Ù†ØµØ¨ Ù…Ø³ØªÙ‚ÛŒÙ… Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§ Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙØ§ÛŒÙ„ package.json Ø¯Ø± Ù…Ø®Ø²Ù†
        run: |
          npm init -y
          npm install react react-dom vite @vitejs/plugin-react archiver fs-extra --save-dev

      - name: Create Dynamic Vite Config
        # Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø¢Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
        run: |
          cat <<EOF > vite.config.mjs
          import { defineConfig } from 'vite';
          import react from '@vitejs/plugin-react';
          import { resolve, join } from 'path';
          import { readdirSync, statSync } from 'fs';

          const pagesPath = resolve(process.cwd(), 'src/pages');
          const pages = readdirSync(pagesPath).filter(f => 
            statSync(join(pagesPath, f)).isDirectory()
          );

          const entryPoints = {};
          pages.forEach(page => {
            entryPoints[page] = resolve(pagesPath, page, 'index.jsx');
          });

          export default defineConfig({
            plugins: [react()],
            build: {
              outDir: 'dist-pages',
              emptyOutDir: true,
              rollupOptions: {
                input: entryPoints,
                output: {
                  entryFileNames: '[name]/[name].js',
                  assetFileNames: '[name]/[name].[ext]',
                  format: 'iife',
                  name: 'PageBundle'
                }
              }
            }
          });
          EOF

      - name: Compile Pages
        run: npx vite build

      - name: Advanced Zip Workflow
        # ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù‡Ø± ØµÙØ­Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª ÛŒÚ© Ù¾Ú©ÛŒØ¬ Ù…Ø¬Ø²Ø§
        run: |
          mkdir -p final-archives
          cd dist-pages
          for dir in */; do
            if [ -d "$dir" ]; then
              tag_name=\${dir%/}
              echo "ğŸ“¦ Archiving Page: \$tag_name"
              zip -r9 "../final-archives/\${tag_name}.zip" "\$dir"
            fi
          done
          cd ..

      - name: Upload Compiled Pages
        uses: actions/upload-artifact@v4
        with:
          name: all-pages-bundle
          path: final-archives/*.zip
          retention-days: 10
